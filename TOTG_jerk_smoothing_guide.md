# 在 C++ 工程中为 TOTG 结果添加 **jerk** 约束的实现指南（markdown.md）

> 本文是**实现指南与注意事项**（不含 C++ 代码）。目标是：在**不修改** `tobiaskunz/trajectories`（Kunz–Stilman TOTG）的前提下，通过**后处理**的方式，把轨迹从“梯形速度/矩形加速度”平滑为**S-型**，实现**有限 jerk**，并**保持与原规划相同的起止速度与位置**。

---

## 0. 适用范围
- 已能从 TOTG 获得均匀采样的路径参数化：`{ t_k, s_k, \dot s_k, \ddot s_k }`。
- 仅做**离线或准在线**后处理（允许一次或少量扫掠），实时环按下发的 \((s,\dot s,\ddot s)\) 回放。
- 需要“近似最优但工程可用”的 jerk 约束（非全局最优解）。若需严格最优，请改造为 S-curve 求解器或采用现成库（如 Ruckig）。

---

## 1. 术语与符号
- \( s \)：路径参数（公共进度变量），\( t \)：时间，采样间隔 \( \Delta t \)，总时长 \( T \)。
- \( a(t)=\ddot s(t) \)（路径参数加速度），\( j(t)=\dddot s(t) \)（jerk）。
- jerk 上界 \( J_{\max} \)，等价窗口 \( T_j=a_{\max}/J_{\max} \)，离散窗长 \( N_j=\lceil T_j/\Delta t\rceil \)。
- 约束函数：\( \dot s \le \overline{\dot s}(s) \)，\( \underline{\ddot s}(s,\dot s)\le \ddot s \le \overline{\ddot s}(s,\dot s) \)。

---

## 2. 目标与“两个矩”守恒（保证起止速度与位置不变）
**要求**：处理后起止满足 \( \dot s(0)=\dot s_0,\ \dot s(T)=\dot s_T \)，\( s(0)=s_0,\ s(T)=s_T \)。  
**等价于**对加速度的两个积分不变：
- 速度增量：\(\displaystyle \int_0^T a(t)\,\mathrm dt = \dot s(T)-\dot s(0)\)；
- 位置增量：\(\displaystyle \int_0^T (T-t)\,a(t)\,\mathrm dt = s(T)-s(0)-\dot s(0)T\)。

> 结论：若把 \( a \) 与**对称核** \( h \) 卷积（\(\tilde a=a*h\)），且核满足  
> （1）**DC 增益为 1**：\(\int h = 1\)（离散 \(\sum h[n]=1\)）；  
> （2）**一阶矩为 0**：\(\int u\,h(u)\mathrm du=0\)（离散 \(\sum n\,h[n]=0\)，核关于中心对称），  
> 并做**正确的边界延拓**，则上述两积分保持不变 ⇒ **末速度与末位置保持不变**。

---

## 3. 实施流程（端点锁定版“方案A”）

### Step 0｜统一时间网格
- 将 TOTG 输出重采样到统一 \(\Delta t\)。保留事件点作为“诊断标记”，但运行管线仅使用均匀网格。

### Step 1｜边界延拓（padding）
- 在首尾各追加至少 \(\lceil N_j/2\rceil\) 个样本：常用为**镜像延拓**或**静止零段延拓**（\(a=0\)），避免边界“吞面积/吞一阶矩”。

### Step 2｜对称核平滑（零相位 FIR）
- 选择 odd 长度、中心对称、\(\sum h=1\) 的核（如三角核/二项式核）。**中心对齐卷积**得到 \(\tilde a_0\)。  
- 这一操作把加速度阶跃磨成线性爬升/下降，初步实现 S-型。

### Step 3｜离散 jerk 限幅（斜率限制器）
- 约束相邻样本斜率：\(|\tilde a_0[k]-\tilde a_0[k-1]| \le J_{\max}\,\Delta t\)，得到 \(\tilde a_1\)。  
- 注意：此非线性夹取可能轻微破坏“两个矩”守恒（见 Step 4 纠偏）。

### Step 4｜“两矩”投影纠偏（保端点的小幅修正）
- 计算误差：  
  \(\displaystyle \Delta v=\sum_k \tilde a_1[k]\Delta t - \sum_k a[k]\Delta t\)，  
  \(\displaystyle \Delta s=\sum_k (T-k\Delta t)\tilde a_1[k]\Delta t - \sum_k (T-k\Delta t)a[k]\Delta t\)。
- 构造两条端点处值与导数全为 0 的光滑基函数（示例）：  
  \( b_0(\xi)=10\xi^3-15\xi^4+6\xi^5,\quad b_1(\xi)=\xi(1-\xi)(1-2\xi),\ \xi=t/T \)。  
- 令 \( \tilde a=\tilde a_1+\alpha b_0(t/T)+\beta b_1(t/T) \)，通过解 2×2 线性方程  
  \([[\phi_{00},\phi_{10}],[\phi_{01},\phi_{11}]][\alpha,\beta]^T=[-\Delta v,-\Delta s]^T\)，  
  其中 \(\phi_{i0}=\int_0^T b_i\,\mathrm dt\)，\(\phi_{i1}=\int_0^T (T-t)b_i\,\mathrm dt\)。  
- 必要时对 \(\alpha b_0+\beta b_1\) 轻扫同一对称核以抑制微小尖角（幅值极小，基本不破“矩”）。

### Step 5｜重新积分 + 可行域前后向投影（守 jerk）
- 以梯形积分得到 \(\tilde{\dot s},\tilde s\)。  
- 逐点检查可行域：\(\tilde{\dot s}\le \overline{\dot s}(s)\)，\(\underline{\ddot s}\le \tilde{\ddot s}\le \overline{\ddot s}\)。  
- 发生越界时执行**前向（0→T）/后向（T→0）投影**：在**\(\ddot s\) 层**做最小修改并保持 \(|\Delta \ddot s| \le J_{\max}\Delta t\)（有界斜率扫描）。

### Step 6｜移除填充 + 多轴同步
- 裁掉填充样本。跨关节保持**同一 \(s(t)\)**，禁止逐轴各自平滑。

---

## 4. 平滑核设计与参数选型
- **核类型**：盒窗（移动平均）、三角（盒窗与自身卷积）、二项式核（近似高斯）、Bessel/临界阻尼 PT2 的离散化对称近似。  
- **必要属性**：对称、\(\sum h=1\)（DC=1），odd 长度，中心对齐。  
- **窗长**：\(N_j=\lceil T_j/\Delta t\rceil\)，\(T_j=a_{\max}/J_{\max}\)。短段上可取更小 \(N_j\) 以避免过度展宽。  
- **避免过冲**：优先选择**非振铃**核（盒窗/三角/二项式、Bessel 近似）。

---

## 5. 边界处理（padding）
- **镜像延拓**（推荐）：以边界处的一阶光滑延拓抑制斜率失真。  
- **静止零段延拓**：在首尾附加 \(a=0\) 的短零段，保证“两个矩”的计算窗充分覆盖核。  
- **切勿**直接“截断卷积”或无填充：会引入端点速度/位置漂移。

---

## 6. 斜率限制器（离散 jerk 约束）
- 规则：\(|\Delta a| \le J_{\max}\Delta t\)。可一次前扫一次后扫，或多次**双向扫描**逼近。  
- 对于**极短段**或 MVC 附近，可能出现“既要守 jerk 又要守可行域”不可兼得 → 首选**拉长总时长 \(T\)** 作为退让。

---

## 7. “两矩”投影纠偏（细节）
- 目的：在 Step 3 的非线性限幅后，**微小地**调节 \(\tilde a\) 让端点完全对齐。  
- 基函数选择要满足：端点值/导数为 0，内部平滑（如 5 次多项式）。  
- 数值上：用梯形积分计算 \(\phi_{ij}\) 与 \(\Delta v,\Delta s\)；矩阵条件数通常良好。

---

## 8. 可行域前后向投影的要点
- 与 TOTG 的“前向-后向”思想一致，但现在**工作在 \(\ddot s\) 层**且受 jerk 限制。  
- 修正顺序：先限速 \(\tilde{\dot s}\)，再夹取 \(\tilde{\ddot s}\)，并保持斜率限制；必要时多次往返直到收敛。  
- 避免在 MVC 尖角处产生震荡：引入**缓冲窗**或减小 \(J_{\max}\)。

---

## 9. 多轴同步策略
- 仅在**公共 \(s(t)\)** 层做平滑，所有关节共享同一进度。否则将出现到达不同步与几何误差。  
- 若单轴约束过紧导致全局受限，可通过**时间伸缩**（统一拉长 \(T\)）维持同步。

---

## 10. 数值稳定与效率建议
- 积分用**梯形积分**（或 Simpson）替代矩形；\(\Delta t\) 与 \(N_j\) 尽量取整。  
- 滑动卷积用**O(1) 滑窗**累计实现以降低抖动与开销。  
- 可选：对 \(a\) 的前后对比做**简单谱能量比**（高频抑制率）作为回归指标。

---

## 11. 常见坑与处理
1) **端点漂移**：核不对称/未归一/无 padding → 使用对称核 + 归一 + 镜像/零段延拓。  
2) **jerk 限幅后端点又偏**：做“两矩”投影纠偏（Step 4）。  
3) **短段不可兼得**：优先拉长 \(T\)（时间伸缩降低 \(a\)/\(j\)）。  
4) **MVC 附近越界**：加做前后向投影，并减小 \(J_{\max}\) 或增大窗长。  
5) **多轴失步**：严禁逐轴独立平滑；必须在 \(s(t)\) 层统一处理。  
6) **控制器回放不一致**：前馈项必须使用**平滑后的** \(\tilde{\dot s},\tilde{\ddot s}\)。

---

## 12. 验收与回归测试清单（建议做成自动化 CI）
- **端点一致**：\(|\tilde v(T)-v(T)|\le \varepsilon_v\)，\(|\tilde s(T)-s(T)|\le \varepsilon_s\)（建议 1e−9～1e−6）。  
- **可行域通过**：全程 \(\tilde{\dot s}\le \overline{\dot s}(s)\)，\(\underline{\ddot s}\le \tilde{\ddot s}\le \overline{\ddot s}\)。  
- **jerk 上界**：\(\max_k |\tilde a[k]-\tilde a[k-1]|/\Delta t \le J_{\max}\)。  
- **单调性**：\(\tilde{\dot s}\ge 0\)，无负速回撤。  
- **平滑性**：比较 \(\sum | \Delta a |\) 或高频能量，确保显著下降。  
- **多轴同步**：各关节到达时刻差 \(\le \varepsilon_t\)，末端几何误差 \(\le \varepsilon_{\text{pose}}\)。

---

## 13. 参数建议（经验法则）
- \(T_j\) 选在原加速段时长 \(T_a\) 的 10–30% 起步；当 \(2T_j>T_a\) 时会退化为“三角式 S 段”。  
- 首选**三角/二项式核**；需要更圆润可再做一次短核卷积而非一次用很长核。  
- MVC 附近适当降低 \(J_{\max}\) 或拉长 \(T\)。

---

## 14. 失败条件与退化策略
- 若在固定 \(T\) 下无法同时满足 jerk 与可行域：**统一时间伸缩**（\(\alpha>1\)）。  
- 若仍失败：放宽 \(J_{\max}\)（有上限的情况下）或保留原 TOTG 作为后备。

---

## 15. 集成接口与数据约定（建议）
- **输入**：均匀网格 \(\{s,\dot s,\ddot s\}\)、\(\Delta t\)、约束模型、\(J_{\max}\) 或 \(T_j\)。  
- **输出**：\(\tilde s,\tilde{\dot s},\tilde{\ddot s}\)（与输入网格对齐）。  
- **元数据**：记录核类型/长度、padding 策略、时间伸缩系数与验收指标，便于复现实验。

---

## 16. 附录：常用对称核（需归一化后使用）
- 长度 3：\[1, 2, 1]（二项式）  
- 长度 5：\[1, 4, 6, 4, 1]  
- 长度 7：\[1, 6, 15, 20, 15, 6, 1]  
- **三角核**：盒窗与自身卷积；**二次/三次核**：多次盒窗卷积（近似 B-spline）。

---

## 17. FAQ（节选）
- **Q：为什么必须“对称 + DC=1”？**  
  A：保证 0 阶矩（速度增量）守恒；对称又保证 1 阶矩为 0（位置增量守恒）。
- **Q：jerk 限幅会破坏端点吗？**  
  A：可能。用“两矩投影纠偏”即可把端点拉回，同时保持修正的平滑性。  
- **Q：为什么在 \(\ddot s\) 层做投影？**  
  A：jerk 约束天然约束的是 \(\ddot s\) 的斜率；在此层修正更容易同时守住 jerk 与可行域。

---

**结论**：通过“对称零相位 FIR + 正确 padding + jerk 斜率限幅 + 两矩投影纠偏 + 可行域前后向投影”，可以在不重写 TOTG 的前提下，得到**jerk 有界、端点不变、可行域内**的 \(s(t)\)。这是一条**工程可落地**且**可自动化回归**的实现路径。
